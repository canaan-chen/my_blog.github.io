---
title: "I2C 模块设计 | 协议基础"
date: 2020-03-17T12:21:30+08:00
categories: ["一个IC工程师的自我修养"]
tags:  ["I2C 学习", "IC Design", "IC 面试"]
draft: false
---

<blockquote>

I2C 总线是很实用的一个总线协议，也是IC 面试时可以讲出点东西的一个素材。鱼叔最近在学习I2C的IP 设计，并且会不断更新，整理成学习笔记分享在我的博客中，希望大家能有所收获。

<!--more-->



## APB I2C 总线协议

### I2C UART SPI 接口对比

- UART 异步接口，需要用波特率发生器来进行同步，传输速率较慢
- SPI 同步接口（Master需要给Slave 提供一个同步时钟）四根信号线（clk/MISO/MOSI）
- I2C 慢同步 ， 半双工（SCL SDA）

### I2C 帧结构

两根线， SDA-数据线，SCL-时钟线，半双工工作模式。

结构：

- Master：SCL 信号源，控制信息流

- Slave: 处于等待状态，Master 会通过地址来搜寻所需要的slave，每一个slave都有一个固定的地址，并且地址的方式可以通过固定或者配置来实现。

  

#### 基本流程

1. 发送起始条件

2. 发送接受设备的地址和任务操作；

3. 发送或者接受数据

4. 接受设备发送相应位 — 应答；

5. 发送停止条件

   

一帧数据8bit， 其中[7:1]为设备地址，而最后一位为数据方向

- [7:1] 地址

- **0: 0 — 发送地址，写操作；1 — 接受数据，读操作**

  

#### 起始条件

当SCL 和SDA是高电平，且 SDA由高电平到低电平切换；

表示总线上要传输信息；

总线在起始条件后表示处于忙碌状态；



#### 停止条件

当SCL 是高电平时，SDA由低电平向高电平切换时；

本次通讯结束，总线进入空闲状态。



#### 位传输要求

每传输一个数据就产生一个时钟脉冲。并且在高电平时采样数据



#### 数据传输结构

数据流： [起始位] [接受数据的地址 6bit] [读写位 ] [数据1, 从7到0，高位先发] [ 应答信号] [数据2, 从7到0，高位先发] [ 应答信号] ... [应答] [停止位]

![](https://image-1301586523.cos.ap-shanghai.myqcloud.com/1.png)

### I2C 的响应机制

Slave 需要在收到数据后给予应答信号，在相应期间，Master需要释放SDA线，而Slave需要将SDA线拉低，表示相应。

#### 无法响应情况：

- 如果从机没有响应，则主机要使数据线一直保持高电平，产生一个停止或者重复条件。
- 如果从机来不及处理数据，可以一直拉低时钟线，使主机处于等待状态

SCL 的线与逻辑保证了时钟线上的同步，比如说clk1 先拉低，但是clk2 的低电平还没有到，这时候MOS2 打开状态，整个SCL还是处于低电平状态，只有当所有的clk都到达变低后，线才被拉高，SCL同步机制来保证SCL 读取数据的同步性

#### 总线仲裁

多个主机使用总线时，当SCL 处于高电平时，根据SDA的电平来进行仲裁；

规则；当主机需要将总线拉高时，但不能实现 —> 丢失仲裁 —> 退回到设备。



### Sample



主机接受流程：

1. 发送起始标志位
2. 发送从机地址和读信号
3. 从机接收到信号发送应答标志，开始发数据
4. 主机接收到数据发送应答信号开始接受下一个数据
5. 主机不想接受信号就发送一个NACK信号然后停止

![](https://image-1301586523.cos.ap-shanghai.myqcloud.com/3.png)



